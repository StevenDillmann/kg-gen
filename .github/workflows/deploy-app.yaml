name: Deploy App to Cloud Run

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:

env:
  GCP_PROJECT_ID: kggen-ai
  CLOUD_RUN_SERVICE: app
  CLOUD_RUN_REGION: us-central1
  ARTIFACT_REGISTRY_REPO: app
  IMAGE_NAME: cloud-run-app
  ARTIFACT_REGISTRY_LOCATION: us-central1

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev
      
      - name: Deploy using deploy.sh script
        env:
          CLOUD_RUN_MAX_INSTANCES: ${{ vars.CLOUD_RUN_MAX_INSTANCES }}
          CLOUD_RUN_MIN_INSTANCES: ${{ vars.CLOUD_RUN_MIN_INSTANCES }}
          CLOUD_RUN_CPU: ${{ vars.CLOUD_RUN_CPU }}
          CLOUD_RUN_MEMORY: ${{ vars.CLOUD_RUN_MEMORY }}
          CLOUD_RUN_CONCURRENCY: ${{ vars.CLOUD_RUN_CONCURRENCY }}
          CLOUD_RUN_SERVICE_ACCOUNT: ${{ vars.CLOUD_RUN_SERVICE_ACCOUNT }}
        run: |
          chmod +x app/deploy.sh
          ./app/deploy.sh
      
      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region="${{ env.CLOUD_RUN_REGION }}" \
            --project="${{ env.GCP_PROJECT_ID }}" \
            --format="value(status.url)")
          
          echo "Service deployed to: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** $CLOUD_RUN_SERVICE" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY